---
import AdminLayout from "../../layouts/AdminLayout.astro";
---

<AdminLayout title="Media Gallery">
    <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-6">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">Media Gallery</h1>
                <p class="text-gray-600">
                    Upload and manage your images (Max 5MB).
                </p>
            </div>
            <button
                id="btn-upload-trigger"
                class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition font-medium flex items-center gap-2"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    ><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
                    ></path><polyline points="17 8 12 3 7 8"></polyline><line
                        x1="12"
                        y1="3"
                        x2="12"
                        y2="15"></line></svg
                >
                Upload Image
            </button>
            <input
                type="file"
                id="file-upload"
                class="hidden"
                accept="image/*"
            />
        </div>

        <!-- Upload Protocol Feedback -->
        <div id="upload-status" class="hidden mb-6 p-4 rounded-md"></div>

        <!-- Gallery Grid -->
        <div
            id="gallery-grid"
            class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"
        >
            <!-- Images injected here -->
        </div>

        <!-- Loading State -->
        <div
            id="loading-skeleton"
            class="hidden grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 mt-6"
        >
            <!-- Simple Skeletons -->
            {
                [1, 2, 3, 4].map(() => (
                    <div class="animate-pulse">
                        <div class="bg-gray-200 h-48 rounded-lg mb-2" />
                        <div class="h-4 bg-gray-200 rounded w-3/4" />
                    </div>
                ))
            }
        </div>

        <!-- Pagination / Load More -->
        <div class="mt-8 text-center">
            <button
                id="btn-load-more"
                class="hidden px-6 py-2 border border-gray-300 rounded-full text-gray-600 hover:bg-gray-50 hover:text-gray-800 transition font-medium"
            >
                Load More
            </button>
            <p id="end-message" class="hidden text-gray-500 text-sm mt-4">
                All images loaded.
            </p>
        </div>
    </div>
</AdminLayout>

<script>
    import { db } from "../../lib/firebase";
    import {
        collection,
        addDoc,
        getDocs,
        query,
        orderBy,
        limit,
        startAfter,
        deleteDoc,
        doc,
        serverTimestamp,
        type QueryDocumentSnapshot,
        type DocumentData,
    } from "firebase/firestore";

    const uploadTrigger = document.getElementById("btn-upload-trigger");
    const fileInput = document.getElementById(
        "file-upload",
    ) as HTMLInputElement;
    const statusDiv = document.getElementById("upload-status");
    const galleryGrid = document.getElementById("gallery-grid");
    const loadMoreBtn = document.getElementById("btn-load-more");
    const endMessage = document.getElementById("end-message");
    const loadingSkeleton = document.getElementById("loading-skeleton");

    const MAX_SIZE_MB = 5;
    const PAGE_SIZE = 12;
    let lastVisible: QueryDocumentSnapshot<DocumentData> | null = null;
    let isLoading = false;

    // --- Upload Logic ---

    uploadTrigger?.addEventListener("click", () => {
        fileInput?.click();
    });

    fileInput?.addEventListener("change", async (e) => {
        const target = e.target as HTMLInputElement;
        const file = target.files?.[0];

        if (!file) return;

        // Validation
        if (!file.type.startsWith("image/")) {
            showStatus("error", "Only image files are allowed.");
            return;
        }

        if (file.size > MAX_SIZE_MB * 1024 * 1024) {
            showStatus(
                "error",
                `File size must be less than ${MAX_SIZE_MB}MB.`,
            );
            return;
        }

        // Upload Process
        showStatus("loading", `Uploading ${file.name}...`);

        const formData = new FormData();
        formData.append("file", file);

        try {
            // 1. Upload to S3 API
            const res = await fetch("/api/upload", {
                method: "POST",
                body: formData,
            });

            const data = await res.json();

            if (!res.ok) {
                throw new Error(data.message || "Upload failed");
            }

            // 2. Save metadata to Firestore
            await addDoc(collection(db, "media_library"), {
                name: file.name,
                type: file.type,
                size: file.size,
                url: data.url,
                key: data.key, // Ensure API returns key, or parse it
                createdAt: serverTimestamp(),
            });

            showStatus("success", "Image uploaded successfully!");
            fileInput.value = ""; // Reset input

            // Refresh first page
            resetGallery();
            loadGallery();
        } catch (error) {
            console.error("Upload Error:", error);
            showStatus("error", "Upload failed: " + (error as Error).message);
        }
    });

    function showStatus(
        type: "loading" | "success" | "error",
        message: string,
    ) {
        if (!statusDiv) return;
        statusDiv.classList.remove(
            "hidden",
            "bg-blue-50",
            "text-blue-700",
            "bg-green-50",
            "text-green-700",
            "bg-red-50",
            "text-red-700",
        );

        if (type === "loading") {
            statusDiv.classList.add("bg-blue-50", "text-blue-700");
        } else if (type === "success") {
            statusDiv.classList.add("bg-green-50", "text-green-700");
            setTimeout(() => statusDiv.classList.add("hidden"), 3000);
        } else {
            statusDiv.classList.add("bg-red-50", "text-red-700");
        }

        statusDiv.textContent = message;
    }

    // --- Gallery Logic ---

    async function loadGallery() {
        if (isLoading) return;
        isLoading = true;
        if (
            loadingSkeleton &&
            (!galleryGrid || galleryGrid.children.length === 0)
        ) {
            loadingSkeleton.classList.remove("hidden");
        }
        if (loadMoreBtn) loadMoreBtn.innerText = "Loading...";

        try {
            let q;
            const collectionRef = collection(db, "media_library");

            if (lastVisible) {
                q = query(
                    collectionRef,
                    orderBy("createdAt", "desc"),
                    startAfter(lastVisible),
                    limit(PAGE_SIZE),
                );
            } else {
                q = query(
                    collectionRef,
                    orderBy("createdAt", "desc"),
                    limit(PAGE_SIZE),
                );
            }

            const querySnapshot = await getDocs(q);

            if (loadingSkeleton) loadingSkeleton.classList.add("hidden");

            if (querySnapshot.empty) {
                if (!lastVisible) {
                    // Empty state for initial load
                    if (galleryGrid)
                        galleryGrid.innerHTML = `<p class="col-span-full text-center text-gray-500 py-10">No images found. Upload one!</p>`;
                }
                if (loadMoreBtn) loadMoreBtn.classList.add("hidden");
                if (endMessage && lastVisible)
                    endMessage.classList.remove("hidden"); // Only show end message if we had some data
                return;
            }

            lastVisible = querySnapshot.docs[querySnapshot.docs.length - 1];

            querySnapshot.forEach((doc) => {
                const data = doc.data();
                const card = createGalleryCard(doc.id, data);
                if (galleryGrid) galleryGrid.appendChild(card);
            });

            if (querySnapshot.size < PAGE_SIZE) {
                if (loadMoreBtn) loadMoreBtn.classList.add("hidden");
                if (endMessage) endMessage.classList.remove("hidden");
            } else {
                if (loadMoreBtn) {
                    loadMoreBtn.classList.remove("hidden");
                    loadMoreBtn.innerText = "Load More";
                }
            }
        } catch (error) {
            console.error("Error loading gallery:", error);
            showStatus("error", "Failed to load gallery.");
        } finally {
            isLoading = false;
        }
    }

    function createGalleryCard(id: string, data: any) {
        const div = document.createElement("div");
        div.className =
            "group relative bg-gray-50 rounded-lg overflow-hidden border border-gray-200 hover:shadow-md transition";
        div.innerHTML = `
            <div class="aspect-square bg-gray-100 relative overflow-hidden">
                <img src="${data.url}" alt="${data.name}" class="w-full h-full object-cover object-center transition duration-500 group-hover:scale-105" loading="lazy" />
                 <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2">
                    <button class="btn-copy p-2 bg-white/90 text-gray-700 rounded-full hover:bg-white hover:text-indigo-600 transition" title="Copy URL">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                    </button>
                    <button class="btn-delete p-2 bg-white/90 text-red-600 rounded-full hover:bg-red-50 hover:text-red-700 transition" title="Delete">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                    </button>
                </div>
            </div>
            <div class="p-3">
                <p class="text-sm font-medium text-gray-800 truncate" title="${data.name}">${data.name}</p>
                <div class="flex justify-between items-center mt-1">
                    <p class="text-xs text-gray-500">${formatBytes(data.size)}</p>
                    <p class="text-xs text-gray-400">${new Date(data.createdAt?.seconds * 1000).toLocaleDateString()}</p>
                </div>
            </div>
        `;

        // Handle Delete
        const deleteBtn = div.querySelector(".btn-delete");
        deleteBtn?.addEventListener("click", async () => {
            if (confirm("Are you sure you want to delete this image?")) {
                await deleteImage(id, data.url, data.key, div);
            }
        });

        // Handle Copy
        const copyBtn = div.querySelector(".btn-copy");
        copyBtn?.addEventListener("click", () => {
            navigator.clipboard.writeText(data.url);
            // Optionally change icon or show toast
            const originalHTML = copyBtn.innerHTML;
            copyBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-600"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
            setTimeout(() => (copyBtn.innerHTML = originalHTML), 2000);
        });

        return div;
    }

    async function deleteImage(
        docId: string,
        url: string,
        key: string,
        element: HTMLElement,
    ) {
        try {
            // 1. S3 Delete
            const res = await fetch("/api/delete-image", {
                method: "DELETE",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ url, key }),
            });

            if (!res.ok) {
                const errData = await res.json();
                throw new Error(errData.message || "Failed to delete from S3");
            }

            // 2. Firestore Delete
            await deleteDoc(doc(db, "media_library", docId));

            // Remove from UI
            element.remove();
        } catch (error) {
            console.error("Delete Error:", error);
            alert("Failed to delete image: " + (error as Error).message);
        }
    }

    function formatBytes(bytes: number, decimals = 2) {
        if (!+bytes) return "0 Bytes";
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
    }

    function resetGallery() {
        if (galleryGrid) galleryGrid.innerHTML = "";
        lastVisible = null;
        if (loadMoreBtn) loadMoreBtn.classList.remove("hidden");
        if (endMessage) endMessage.classList.add("hidden");
    }

    // Initialize
    loadMoreBtn?.addEventListener("click", loadGallery);
    loadGallery(); // Initial Load
</script>
